<?php
/*
Plugin Name: Kovacic Pipeline Visualizer
Description: Kanban de procesos con relación Cliente→Proceso y candidatos vinculados. Filtros por Cliente/Proceso, edición desde UI, estados/columnas configurables, subida de CV, notas, añadir/duplicar perfil con búsqueda, eliminación y exportación CSV/XLS.
Version: 1.6.0
Author: Kovacic Executive Talent Research
*/

if (!defined('ABSPATH')) exit;

class Kovacic_Pipeline_Visualizer {
    const CPT           = 'kvt_candidate';
    const TAX_CLIENT    = 'kvt_client';
    const TAX_PROCESS   = 'kvt_process';
    const OPT_GROUP     = 'kvt_options';
    const OPT_STATUSES  = 'kvt_statuses';
    const OPT_COLUMNS   = 'kvt_columns';

    public function __construct() {
        add_action('init',                       [$this, 'register_types']);
        add_action('admin_init',                 [$this, 'register_settings']);
        add_action('admin_menu',                 [$this, 'admin_menu']);

        // Process term meta: attach Process → Client
        add_action(self::TAX_PROCESS . '_add_form_fields',  [$this, 'process_add_fields']);
        add_action(self::TAX_PROCESS . '_edit_form_fields', [$this, 'process_edit_fields']);
        add_action('created_' . self::TAX_PROCESS,          [$this, 'save_process_term'], 10, 2);
        add_action('edited_'  . self::TAX_PROCESS,          [$this, 'save_process_term'], 10, 2);

        // Candidate admin UI
        add_action('add_meta_boxes',             [$this, 'add_meta_boxes']);
        add_action('save_post_' . self::CPT,     [$this, 'save_candidate_meta']);

        // Replace default taxonomy boxes with dropdown-only (no manual add)
        add_action('admin_menu',                 [$this, 'replace_tax_metaboxes']);

        add_shortcode('kovacic_pipeline',        [$this, 'shortcode']);
        add_action('wp_enqueue_scripts',         [$this, 'enqueue_assets']);

        // AJAX (frontend)
        add_action('wp_ajax_kvt_get_candidates',     [$this, 'ajax_get_candidates']);
        add_action('wp_ajax_kvt_update_status',      [$this, 'ajax_update_status']);
        add_action('wp_ajax_kvt_update_notes',       [$this, 'ajax_update_notes']);
        add_action('wp_ajax_kvt_delete_notes',       [$this, 'ajax_delete_notes']);
        add_action('wp_ajax_kvt_delete_candidate',   [$this, 'ajax_delete_candidate']);

        // New: Edit profile from UI
        add_action('wp_ajax_kvt_update_profile',     [$this, 'ajax_update_profile']);

        // List & create/clone with search + client/process selection
        add_action('wp_ajax_kvt_list_profiles',      [$this, 'ajax_list_profiles']);
        add_action('wp_ajax_kvt_clone_profile',      [$this, 'ajax_clone_profile']);

        // Export
        add_action('admin_post_kvt_export',      [$this, 'handle_export']);

        add_action('plugins_loaded',             [$this, 'ensure_defaults']);
    }

    public function ensure_defaults() {
        if (get_option(self::OPT_STATUSES) === false) {
            update_option(self::OPT_STATUSES, "Identified\nContacted\nInterviewed\nOffer\nDeclined");
        }
        if (get_option(self::OPT_COLUMNS) === false) {
            update_option(self::OPT_COLUMNS,
"first_name|Nombre
last_name|Apellidos
email|Email
phone|Teléfono
country|País
city|Ciudad
cv_url|CV (URL)
cv_uploaded|Fecha de subida");
        }
    }

    /* =========================
     * Types & Taxonomies
     * ========================= */
    public function register_types() {
        register_post_type(self::CPT, [
            'labels' => [
                'name' => 'Candidatos',
                'singular_name' => 'Candidato',
                'add_new_item' => 'Añadir candidato',
                'edit_item' => 'Editar candidato',
                'view_item' => 'Ver candidato',
                'search_items' => 'Buscar candidatos',
            ],
            'public' => false,
            'show_ui' => true,
            'supports' => ['title'],
            'menu_icon' => 'dashicons-groups',
        ]);

        register_taxonomy(self::TAX_CLIENT, [self::CPT], [
            'labels' => ['name' => 'Clientes','singular_name' => 'Cliente'],
            'public' => false,'show_ui' => true,'hierarchical' => false,
            'meta_box_cb' => null,
        ]);

        register_taxonomy(self::TAX_PROCESS, [self::CPT], [
            'labels' => ['name' => 'Procesos','singular_name' => 'Proceso'],
            'public' => false,'show_ui' => true,'hierarchical' => false,
            'meta_box_cb' => null,
        ]);
    }

    /* =========================
     * Settings page
     * ========================= */
    public function register_settings() {
        register_setting(self::OPT_GROUP, self::OPT_STATUSES);
        register_setting(self::OPT_GROUP, self::OPT_COLUMNS);
    }
    public function admin_menu() {
        add_options_page('Kovacic Pipeline','Kovacic Pipeline','manage_options','kvt-settings',[$this,'settings_page']);
    }
    public function settings_page() {
        $statuses = get_option(self::OPT_STATUSES, "");
        $columns  = get_option(self::OPT_COLUMNS, "");
        ?>
        <div class="wrap">
            <h1>Kovacic Pipeline — Ajustes</h1>
            <form method="post" action="options.php">
                <?php settings_fields(self::OPT_GROUP); ?>
                <table class="form-table" role="presentation">
                    <tr>
                        <th scope="row"><label for="<?php echo self::OPT_STATUSES; ?>">Estados del pipeline</label></th>
                        <td>
                            <textarea name="<?php echo self::OPT_STATUSES; ?>" id="<?php echo self::OPT_STATUSES; ?>" rows="8" class="large-text" placeholder="Un estado por línea, de izquierda a derecha en el tablero"><?php echo esc_textarea($statuses); ?></textarea>
                            <p class="description">Ejemplo (uno por línea): Identified, Contacted, Interviewed, Offer, Declined</p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><label for="<?php echo self::OPT_COLUMNS; ?>">Columnas de datos (tabla/exportación)</label></th>
                        <td>
                            <textarea name="<?php echo self::OPT_COLUMNS; ?>" id="<?php echo self::OPT_COLUMNS; ?>" rows="10" class="large-text" placeholder="meta_key|Etiqueta visible"><?php echo esc_textarea($columns); ?></textarea>
                            <p class="description">
                                Formato: <code>meta_key|Etiqueta</code> (una por línea).<br>
                                Por defecto: <code>first_name, last_name, email, phone, country, city, cv_url, cv_uploaded</code><br>
                                Puedes añadir <code>notes|Notas</code> para exportar notas si lo deseas.
                            </p>
                        </td>
                    </tr>
                </table>
                <?php submit_button('Guardar ajustes'); ?>
            </form>
        </div>
        <?php
    }

    /* =========================
     * Process term meta: link Process → Client
     * ========================= */
    public function process_add_fields($taxonomy) {
        $clients = get_terms(['taxonomy'=>self::TAX_CLIENT,'hide_empty'=>false]); ?>
        <div class="form-field">
            <label for="kvt_process_client">Cliente asociado</label>
            <select name="kvt_process_client" id="kvt_process_client">
                <option value="">— Ninguno —</option>
                <?php foreach ($clients as $c): ?>
                    <option value="<?php echo esc_attr($c->term_id); ?>"><?php echo esc_html($c->name); ?></option>
                <?php endforeach; ?>
            </select>
            <p class="description">(Opcional) Vincula este proceso a un cliente. Sirve para filtrar procesos por cliente.</p>
        </div>
        <?php
    }
    public function process_edit_fields($term) {
        $clients = get_terms(['taxonomy'=>self::TAX_CLIENT,'hide_empty'=>false]);
        $current = get_term_meta($term->term_id, 'kvt_process_client', true);
        ?>
        <tr class="form-field">
            <th scope="row"><label for="kvt_process_client">Cliente asociado</label></th>
            <td>
                <select name="kvt_process_client" id="kvt_process_client">
                    <option value="">— Ninguno —</option>
                    <?php foreach ($clients as $c): ?>
                        <option value="<?php echo esc_attr($c->term_id); ?>" <?php selected($current, $c->term_id); ?>>
                            <?php echo esc_html($c->name); ?>
                        </option>
                    <?php endforeach; ?>
                </select>
                <p class="description">(Opcional) Vincula este proceso a un cliente. Sirve para filtrar procesos por cliente.</p>
            </td>
        </tr>
        <?php
    }
    public function save_process_term($term_id, $tt_id) {
        if (isset($_POST['kvt_process_client'])) {
            $client_id = intval($_POST['kvt_process_client']);
            if ($client_id > 0) {
                update_term_meta($term_id, 'kvt_process_client', $client_id);
            } else {
                delete_term_meta($term_id, 'kvt_process_client');
            }
        }
    }

    /* =========================
     * Candidate admin: meta + custom taxonomy dropdowns
     * ========================= */
    public function replace_tax_metaboxes() {
        // Remove default boxes
        remove_meta_box(self::TAX_CLIENT.'div', self::CPT, 'side');
        remove_meta_box(self::TAX_PROCESS.'div', self::CPT, 'side');

        // Add our dropdown-only boxes
        add_meta_box('kvt_client_box',  'Cliente',  [$this,'render_client_dropdown'],  self::CPT, 'side', 'default');
        add_meta_box('kvt_process_box', 'Proceso',  [$this,'render_process_dropdown'], self::CPT, 'side', 'default');
    }
    public function render_client_dropdown($post) {
        wp_nonce_field('kvt_save_candidate', 'kvt_nonce');
        $terms = get_terms(['taxonomy'=>self::TAX_CLIENT,'hide_empty'=>false]);
        $assigned = wp_get_object_terms($post->ID, self::TAX_CLIENT, ['fields'=>'ids']);
        $current  = isset($assigned[0]) ? (int)$assigned[0] : 0;
        echo '<select name="kvt_client_term" id="kvt_client_term" class="widefat">';
        echo '<option value="">— Ninguno —</option>';
        foreach ($terms as $t) {
            echo '<option value="'.esc_attr($t->term_id).'" '.selected($current,$t->term_id,false).'>'.esc_html($t->name).'</option>';
        }
        echo '</select><p class="description">Solo seleccionar existentes.</p>';
    }
    public function render_process_dropdown($post) {
        $terms = get_terms(['taxonomy'=>self::TAX_PROCESS,'hide_empty'=>false]);
        $assigned = wp_get_object_terms($post->ID, self::TAX_PROCESS, ['fields'=>'ids']);
        $current  = isset($assigned[0]) ? (int)$assigned[0] : 0;
        echo '<select name="kvt_process_term" id="kvt_process_term" class="widefat">';
        echo '<option value="">— Ninguno —</option>';
        foreach ($terms as $t) {
            echo '<option value="'.esc_attr($t->term_id).'" '.selected($current,$t->term_id,false).'>'.esc_html($t->name).'</option>';
        }
        echo '</select><p class="description">Al guardar con Proceso, se asignará automáticamente el Cliente vinculado a ese Proceso.</p>';
    }

    public function add_meta_boxes() {
        add_meta_box('kvt_candidate_details', 'Datos del candidato', [$this, 'metabox_candidate'], self::CPT, 'normal', 'high');
        add_meta_box('kvt_candidate_status',  'Estado del pipeline',  [$this, 'metabox_status'],    self::CPT, 'side',   'high');
    }

    /** Compatibility getter: tries main key, then legacy fallbacks */
    private function meta_get_compat($post_id, $key, $fallbacks = []) {
        $v = get_post_meta($post_id, $key, true);
        if ($v !== '' && $v !== null) return $v;
        foreach ($fallbacks as $fb) {
            $vv = get_post_meta($post_id, $fb, true);
            if ($vv !== '' && $vv !== null) return $vv;
        }
        return '';
    }

    public function metabox_candidate($post) {
        wp_nonce_field('kvt_save_candidate', 'kvt_nonce');

        // Read with legacy compatibility (if old data existed without kvt_ prefix)
        $first   = $this->meta_get_compat($post->ID, 'kvt_first_name',  ['first_name']);
        $last    = $this->meta_get_compat($post->ID, 'kvt_last_name',   ['last_name']);
        $email   = $this->meta_get_compat($post->ID, 'kvt_email',       ['email']);
        $phone   = $this->meta_get_compat($post->ID, 'kvt_phone',       ['phone']);
        $country = $this->meta_get_compat($post->ID, 'kvt_country',     ['country']);
        $city    = $this->meta_get_compat($post->ID, 'kvt_city',        ['city']);
        $cv_url  = $this->meta_get_compat($post->ID, 'kvt_cv_url',      ['cv_url']);
        $cv_date = $this->meta_get_compat($post->ID, 'kvt_cv_uploaded', ['cv_uploaded']);
        $cv_att  = $this->meta_get_compat($post->ID, 'kvt_cv_attachment_id', ['cv_attachment_id']);
        $notes   = $this->meta_get_compat($post->ID, 'kvt_notes',       ['notes']);

        ?>
        <table class="form-table">
            <tr><th><label>Nombre</label></th>
                <td><input type="text" name="kvt_first_name" value="<?php echo esc_attr($first); ?>" class="regular-text"></td></tr>
            <tr><th><label>Apellidos</label></th>
                <td><input type="text" name="kvt_last_name" value="<?php echo esc_attr($last); ?>" class="regular-text"></td></tr>
            <tr><th><label>Email</label></th>
                <td><input type="email" name="kvt_email" value="<?php echo esc_attr($email); ?>" class="regular-text"></td></tr>
            <tr><th><label>Teléfono</label></th>
                <td><input type="text" name="kvt_phone" value="<?php echo esc_attr($phone); ?>" class="regular-text"></td></tr>
            <tr><th><label>País</label></th>
                <td><input type="text" name="kvt_country" value="<?php echo esc_attr($country); ?>" class="regular-text"></td></tr>
            <tr><th><label>Ciudad</label></th>
                <td><input type="text" name="kvt_city" value="<?php echo esc_attr($city); ?>" class="regular-text"></td></tr>

            <tr><th><label>CV (URL)</label></th>
                <td>
                    <input type="url" name="kvt_cv_url" value="<?php echo esc_attr($cv_url); ?>" class="regular-text" placeholder="https://...">
                    <?php if ($cv_url): ?>
                        <p style="margin:.4em 0 0;"><a href="<?php echo esc_url($cv_url); ?>" target="_blank" rel="noopener">Abrir CV actual</a></p>
                    <?php endif; ?>
                    <?php if ($cv_att): ?>
                        <p style="margin:.2em 0 0;color:#555;">Adjunto en biblioteca (ID: <?php echo intval($cv_att); ?>)</p>
                    <?php endif; ?>
                </td>
            </tr>
            <tr><th><label>Subir CV (PDF/DOC/DOCX)</label></th>
                <td>
                    <input type="file" name="kvt_cv_file" accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
                    <?php if ($cv_url || $cv_att): ?>
                        <p style="margin:.4em 0 0;">
                            <label><input type="checkbox" name="kvt_cv_remove" value="1"> Eliminar CV actual</label>
                        </p>
                    <?php endif; ?>
                    <p class="description" style="margin:.4em 0 0;">Si subes un archivo, guardaremos el enlace en “CV (URL)” y registraremos la fecha (si está vacía).</p>
                </td>
            </tr>

            <tr><th><label>Fecha de subida</label></th>
                <td><input type="datetime-local" name="kvt_cv_uploaded" value="<?php echo esc_attr($cv_date); ?>"></td></tr>

            <tr><th><label>Notas</label></th>
                <td>
                    <textarea name="kvt_notes" rows="6" class="large-text" placeholder="Notas internas sobre el candidato (visibles solo para el equipo)"><?php echo esc_textarea($notes); ?></textarea>
                </td>
            </tr>
        </table>
        <p class="description">Asigna el <strong>Proceso</strong> en la caja lateral. Se autovinculará el <strong>Cliente</strong> conectado a ese Proceso.</p>
        <?php
    }

    public function metabox_status($post) {
        $status = get_post_meta($post->ID, 'kvt_status', true);
        $statuses = $this->get_statuses(); ?>
        <p><label for="kvt_status">Estado actual</label></p>
        <select name="kvt_status" id="kvt_status" class="widefat">
            <?php foreach ($statuses as $st): ?>
                <option value="<?php echo esc_attr($st); ?>" <?php selected($status, $st); ?>><?php echo esc_html($st); ?></option>
            <?php endforeach; ?>
        </select>
        <?php
    }

    public function save_candidate_meta($post_id) {
        if (!isset($_POST['kvt_nonce']) || !wp_verify_nonce($_POST['kvt_nonce'], 'kvt_save_candidate')) return;
        if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) return;
        if (!current_user_can('edit_post', $post_id)) return;

        $uploaded_url = '';
        $uploaded_dt  = '';

        // Remove CV if requested (before any changes)
        if (!empty($_POST['kvt_cv_remove'])) {
            $att_id = (int) get_post_meta($post_id, 'kvt_cv_attachment_id', true);
            if ($att_id) wp_delete_attachment($att_id, true);
            delete_post_meta($post_id, 'kvt_cv_attachment_id');
            delete_post_meta($post_id, 'kvt_cv_url');
            delete_post_meta($post_id, 'cv_url');
        }

        // Handle file upload FIRST so it wins over empty inputs
        if (!empty($_FILES['kvt_cv_file']['name'])) {
            if (!function_exists('media_handle_upload')) {
                require_once ABSPATH . 'wp-admin/includes/image.php';
                require_once ABSPATH . 'wp-admin/includes/file.php';
                require_once ABSPATH . 'wp-admin/includes/media.php';
            }
            add_filter('upload_mimes', function($mimes){
                $mimes['pdf']  = 'application/pdf';
                $mimes['doc']  = 'application/msword';
                $mimes['docx'] = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                return $mimes;
            });
            $attach_id = media_handle_upload('kvt_cv_file', $post_id);
            if (!is_wp_error($attach_id)) {
                $uploaded_url = wp_get_attachment_url($attach_id);
                update_post_meta($post_id, 'kvt_cv_attachment_id', $attach_id);
                if ($uploaded_url) {
                    update_post_meta($post_id, 'kvt_cv_url', esc_url_raw($uploaded_url));
                    update_post_meta($post_id, 'cv_url', esc_url_raw($uploaded_url)); // legacy
                }
                if (empty($_POST['kvt_cv_uploaded'])) {
                    $dt = current_time('mysql');
                    $uploaded_dt = str_replace(' ', 'T', substr($dt, 0, 16));
                    update_post_meta($post_id, 'kvt_cv_uploaded', $uploaded_dt);
                    update_post_meta($post_id, 'cv_uploaded', $uploaded_dt); // legacy
                }
            } else {
                error_log('[KVT] Error subiendo CV: ' . $attach_id->get_error_message());
            }
        }

        // Save fields & migrate to legacy keys for compatibility
        $fields = [
            'kvt_first_name' => ['first_name'],
            'kvt_last_name'  => ['last_name'],
            'kvt_email'      => ['email'],
            'kvt_phone'      => ['phone'],
            'kvt_country'    => ['country'],
            'kvt_city'       => ['city'],
            'kvt_cv_url'     => ['cv_url'],
            'kvt_cv_uploaded'=> ['cv_uploaded'],
            'kvt_status'     => [],
            'kvt_notes'      => ['notes'],
        ];
        foreach ($fields as $k => $fallbacks) {
            // If we already uploaded a file, don't overwrite cv_url/cv_uploaded with empty POST
            if ($k === 'kvt_cv_url' && $uploaded_url) continue;
            if ($k === 'kvt_cv_uploaded' && $uploaded_dt) continue;

            if (isset($_POST[$k])) {
                $val = ($k==='kvt_notes') ? wp_kses_post($_POST[$k])
                      : (($k==='kvt_email') ? sanitize_email($_POST[$k]) : sanitize_text_field($_POST[$k]));
                update_post_meta($post_id, $k, $val);
                foreach ($fallbacks as $fb) {
                    update_post_meta($post_id, $fb, $val);
                }
            }
        }

        // Client / Process dropdowns (no manual terms)
        $client_term  = isset($_POST['kvt_client_term'])  ? intval($_POST['kvt_client_term'])  : 0;
        $process_term = isset($_POST['kvt_process_term']) ? intval($_POST['kvt_process_term']) : 0;

        if ($process_term > 0) {
            wp_set_object_terms($post_id, [$process_term], self::TAX_PROCESS, false);
            // Auto-attach linked client
            $linked_client = (int) get_term_meta($process_term, 'kvt_process_client', true);
            if ($linked_client > 0) {
                wp_set_object_terms($post_id, [$linked_client], self::TAX_CLIENT, false);
            } elseif ($client_term > 0) {
                wp_set_object_terms($post_id, [$client_term], self::TAX_CLIENT, false);
            }
        } else {
            if ($client_term > 0) {
                wp_set_object_terms($post_id, [$client_term], self::TAX_CLIENT, false);
            } else {
                wp_set_object_terms($post_id, [], self::TAX_CLIENT, false);
                wp_set_object_terms($post_id, [], self::TAX_PROCESS, false);
            }
        }

        // Title fallback
        $title = get_the_title($post_id);
        if (!$title) {
            $fn = get_post_meta($post_id, 'kvt_first_name', true);
            $ln = get_post_meta($post_id, 'kvt_last_name', true);
            $new = trim($fn . ' ' . $ln);
            if ($new) wp_update_post(['ID'=>$post_id,'post_title'=>$new]);
        }
    }

    /* =========================
     * Helpers
     * ========================= */
    private function get_statuses() {
        $raw = get_option(self::OPT_STATUSES, "");
        $lines = preg_split('/\r\n|\r|\n/', (string)$raw);
        $out = [];
        foreach ($lines as $l) { $l = trim($l); if ($l !== '') $out[] = $l; }
        if (empty($out)) $out = ['Identified','Contacted','Interviewed','Offer','Declined'];
        return $out;
    }
    private function get_columns() {
        $raw = get_option(self::OPT_COLUMNS, "");
        $lines = preg_split('/\r\n|\r|\n/', (string)$raw);
        $cols = [];
        foreach ($lines as $l) {
            $l = trim($l); if ($l === '') continue;
            $parts = explode('|', $l, 2);
            $key = trim($parts[0]);
            $label = isset($parts[1]) ? trim($parts[1]) : $key;
            $cols[] = ['key'=>$key,'label'=>$label];
        }
        if (empty($cols)) {
            $cols = [
                ['key'=>'first_name','label'=>'Nombre'],
                ['key'=>'last_name','label'=>'Apellidos'],
                ['key'=>'email','label'=>'Email'],
                ['key'=>'phone','label'=>'Teléfono'],
                ['key'=>'country','label'=>'País'],
                ['key'=>'city','label'=>'Ciudad'],
                ['key'=>'cv_url','label'=>'CV (URL)'],
                ['key'=>'cv_uploaded','label'=>'Fecha de subida'],
            ];
        }
        return $cols;
    }
    private function get_process_map() {
        $terms = get_terms(['taxonomy'=>self::TAX_PROCESS,'hide_empty'=>false]);
        $out = [];
        foreach ($terms as $t) {
            $cid = (int) get_term_meta($t->term_id, 'kvt_process_client', true);
            $out[] = ['id'=>$t->term_id, 'name'=>$t->name, 'client_id'=>$cid ?: 0];
        }
        return $out;
    }
    private function count_notes($notes) {
        $notes = (string) $notes;
        if ($notes === '') return 0;
        $lines = preg_split('/\r\n|\r|\n/', $notes);
        $cnt = 0;
        foreach ($lines as $ln) if (trim($ln) !== '') $cnt++;
        return $cnt;
    }

    /* =========================
     * Shortcode UI
     * ========================= */
    public function shortcode($atts = []) {
        if (!is_user_logged_in() || !current_user_can('edit_posts')) {
            return '<div class="kvt-wrapper"><p>Debes iniciar sesión para ver el pipeline.</p></div>';
        }

        $clients   = get_terms(['taxonomy'=>self::TAX_CLIENT, 'hide_empty'=>false]);
        $processes = get_terms(['taxonomy'=>self::TAX_PROCESS,'hide_empty'=>false]);
        $proc_map  = $this->get_process_map();

        ob_start(); ?>
        <div class="kvt-wrapper">
            <div class="kvt-toolbar">
                <div class="kvt-filters">
                    <label>Cliente
                        <select id="kvt_client">
                            <option value="">— Todos —</option>
                            <?php foreach ($clients as $t): ?>
                                <option value="<?php echo esc_attr($t->term_id); ?>"><?php echo esc_html($t->name); ?></option>
                            <?php endforeach; ?>
                        </select>
                    </label>
                    <label>Proceso
                        <select id="kvt_process">
                            <option value="">— Todos —</option>
                            <?php foreach ($processes as $t): ?>
                                <option value="<?php echo esc_attr($t->term_id); ?>"><?php echo esc_html($t->name); ?></option>
                            <?php endforeach; ?>
                        </select>
                    </label>
                    <label>Búsqueda
                        <input type="text" id="kvt_search" placeholder="Nombre, email, ciudad…">
                    </label>
                    <button class="kvt-btn" id="kvt_refresh">Actualizar</button>
                </div>
                <div class="kvt-actions">
                    <button class="kvt-btn" id="kvt_add_profile">Añadir perfil</button>
                    <button class="kvt-btn kvt-secondary" id="kvt_toggle_table">Tabla</button>
                    <form id="kvt_export_form" method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>" target="_blank" style="display:inline;">
                        <input type="hidden" name="action" value="kvt_export">
                        <input type="hidden" name="kvt_export_nonce" value="<?php echo esc_attr(wp_create_nonce('kvt_export')); ?>">
                        <input type="hidden" name="filter_client"  id="kvt_export_client"  value="">
                        <input type="hidden" name="filter_process" id="kvt_export_process" value="">
                        <input type="hidden" name="filter_search"  id="kvt_export_search"  value="">
                        <input type="hidden" name="format"         id="kvt_export_format"   value="csv">
                        <button class="kvt-btn" type="button" id="kvt_export_csv">Export CSV</button>
                        <button class="kvt-btn" type="button" id="kvt_export_xls">Export Excel</button>
                    </form>
                </div>
            </div>

            <div id="kvt_board" class="kvt-board" aria-live="polite"></div>

            <div id="kvt_table_wrap" class="kvt-table-wrap" style="display:none;">
                <table id="kvt_table">
                    <thead><tr id="kvt_table_head"></tr></thead>
                    <tbody id="kvt_table_body"></tbody>
                </table>
            </div>
        </div>

        <!-- Modal Añadir Perfil -->
        <div class="kvt-modal" id="kvt_modal" style="display:none;">
          <div class="kvt-modal-content" role="dialog" aria-modal="true" aria-labelledby="kvt_modal_title">
            <div class="kvt-modal-header">
              <h3 id="kvt_modal_title">Añadir perfil</h3>
              <button type="button" class="kvt-modal-close dashicons dashicons-no-alt" title="Cerrar"></button>
            </div>
            <div class="kvt-modal-body">
              <div class="kvt-modal-controls">
                <label>Cliente
                  <select id="kvt_modal_client">
                    <option value="">— Ninguno —</option>
                    <?php foreach ($clients as $c): ?>
                      <option value="<?php echo esc_attr($c->term_id); ?>"><?php echo esc_html($c->name); ?></option>
                    <?php endforeach; ?>
                  </select>
                </label>
                <label>Proceso
                  <select id="kvt_modal_process">
                    <option value="">— Ninguno —</option>
                    <?php foreach ($processes as $t): ?>
                      <option value="<?php echo esc_attr($t->term_id); ?>"><?php echo esc_html($t->name); ?></option>
                    <?php endforeach; ?>
                  </select>
                </label>
                <label>Buscar
                  <input type="text" id="kvt_modal_search" placeholder="Nombre o email…">
                </label>
                <button type="button" class="kvt-btn" id="kvt_modal_create_empty">Crear vacío</button>
              </div>
              <div id="kvt_modal_list" class="kvt-modal-list"></div>
              <div class="kvt-modal-pager">
                <button type="button" class="kvt-btn kvt-secondary" id="kvt_modal_prev">Anterior</button>
                <span id="kvt_modal_pageinfo"></span>
                <button type="button" class="kvt-btn kvt-secondary" id="kvt_modal_next">Siguiente</button>
              </div>
            </div>
          </div>
        </div>
        <?php
        // Make process map available early
        wp_register_script('kvt-process-map', '', [], null, true);
        wp_enqueue_script('kvt-process-map');
        wp_add_inline_script('kvt-process-map', 'window.KVT_PROCESS_MAP=' . wp_json_encode($proc_map) . ';', 'after');

        return ob_get_clean();
    }

    /* =========================
     * Assets (CSS/JS)
     * ========================= */
    public function enqueue_assets() {
        // Dashicons
        wp_enqueue_style('dashicons');

        $css = "
        .kvt-wrapper{max-width:1200px;margin:0 auto;padding:16px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
        .kvt-toolbar{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px}
        .kvt-filters label{margin-right:12px;display:inline-flex;gap:6px;align-items:center;font-weight:600}
        .kvt-filters input,.kvt-filters select{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px}
        .kvt-btn{background:#0A212E;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
        .kvt-btn:hover{opacity:.95}
        .kvt-secondary{background:#475569}
        .kvt-board{display:flex;gap:12px;overflow-x:auto;padding-bottom:6px}
        .kvt-col{min-width:260px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:10px;flex:0 0 260px}
        .kvt-col h3{margin:0 0 8px;font-size:16px;color:#0A212E}
        .kvt-dropzone{min-height:60px;display:flex;flex-direction:column;gap:8px}
        .kvt-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px;box-shadow:0 3px 10px rgba(0,0,0,.04);cursor:grab;overflow-wrap:anywhere;word-break:break-word}
        .kvt-card.dragging{opacity:.6}
        .kvt-card .kvt-title{font-weight:700;margin:0 0 4px;overflow-wrap:anywhere;word-break:break-word}
        .kvt-card .kvt-sub{font-size:12px;color:#64748b;margin:0;overflow-wrap:anywhere;word-break:break-word}
        .kvt-card .kvt-meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;font-size:12px;color:#334155;align-items:center;overflow-wrap:anywhere;word-break:break-word}
        .kvt-card .kvt-expand{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
        .kvt-card .kvt-expand button{background:#eef2f7;color:#0A212E;border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:600}
        .kvt-card .kvt-panel{display:none;margin-top:8px;border-top:1px dashed #e2e8f0;padding-top:8px}
        .kvt-card .kvt-panel dl{display:grid;grid-template-columns:120px 1fr;gap:6px 10px;font-size:13px}
        .kvt-card .kvt-panel dt{font-weight:700;color:#0A212E}
        .kvt-card .kvt-panel dd{margin:0}
        .kvt-input{width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:8px}
        .kvt-card .kvt-notes{margin-top:8px}
        .kvt-card .kvt-notes textarea{width:100%;min-height:80px;padding:8px;border:1px solid #e5e7eb;border-radius:8px}
        .kvt-card .kvt-notes .row{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
        .kvt-card .kvt-notes .row button{padding:8px 10px;border-radius:8px;border:1px solid #e5e7eb;background:#0A212E;color:#fff;cursor:pointer}
        .kvt-card .kvt-notes .row button.kvt-danger{background:#b91c1c}
        .kvt-badge{display:inline-block;font-size:11px;background:#e2e8f0;border:1px solid #cbd5e1;border-radius:999px;padding:2px 8px;margin-left:6px;color:#0A212E}
        .kvt-empty{padding:16px;color:#475569;font-style:italic}
        .kvt-delete{background:none !important;border:none !important;color:#b91c1c !important;font-size:18px;line-height:1;cursor:pointer;padding:0}
        .kvt-delete:hover{color:#7f1d1d !important}
        .kvt-delete.dashicons{vertical-align:middle}
        .kvt-table-wrap{margin-top:16px;overflow:auto;border:1px solid #e5e7eb;border-radius:12px}
        #kvt_table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
        #kvt_table thead th{position:sticky;top:0;background:#0A212E;color:#fff;padding:10px;border-bottom:1px solid #0A212E;text-align:left}
        #kvt_table td{padding:8px;border-bottom:1px solid #e5e7eb;overflow-wrap:anywhere;word-break:break-word}
        /* Modal */
        .kvt-modal{position:fixed;inset:0;background:rgba(2,6,23,.5);display:flex;align-items:center;justify-content:center;z-index:9999}
        .kvt-modal-content{background:#fff;max-width:980px;width:95%;border-radius:12px;box-shadow:0 15px 40px rgba(0,0,0,.2)}
        .kvt-modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb}
        .kvt-modal-body{padding:12px 16px}
        .kvt-modal-close{background:none;border:none;cursor:pointer}
        .kvt-modal-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
        .kvt-modal-controls select,.kvt-modal-controls input{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px}
        .kvt-modal-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;max-height:420px;overflow:auto}
        .kvt-card-mini{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
        .kvt-card-mini h4{margin:0 0 6px}
        .kvt-mini-actions{display:flex;gap:8px;margin-top:8px}
        .kvt-modal-pager{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:10px}
        ";
        wp_register_style('kvt-style', false);
        wp_enqueue_style('kvt-style');
        wp_add_inline_style('kvt-style', $css);

        if (is_user_logged_in() && current_user_can('edit_posts')) {
        // Use a real core script as carrier so inline always prints
        wp_enqueue_script('wp-util'); // small, always available
        
        // Inject constants BEFORE main JS
        $statuses = $this->get_statuses();
        $columns  = $this->get_columns();
        
        wp_add_inline_script('wp-util', 'console.log("[KVT] booting…");', 'before');
        wp_add_inline_script('wp-util', 'const KVT_STATUSES='.wp_json_encode($statuses).';', 'before');
        wp_add_inline_script('wp-util', 'const KVT_COLUMNS='.wp_json_encode($columns).';',  'before');
        wp_add_inline_script('wp-util', 'const KVT_AJAX="'.esc_js(admin_url('admin-ajax.php')).'";', 'before');
        wp_add_inline_script('wp-util', 'const KVT_NONCE="'.esc_js(wp_create_nonce('kvt_nonce')).'";', 'before');
        wp_add_inline_script('wp-util', 'window.KVT_PROCESS_MAP = window.KVT_PROCESS_MAP || [];', 'before');


            $js = <<<'JS'
(function(){
  const el = (sel, root=document)=>root.querySelector(sel);
  const els = (sel, root=document)=>Array.from(root.querySelectorAll(sel));
  const esc = (s)=>String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
  const escAttr = esc;

  const board = el('#kvt_board');
  const tableWrap = el('#kvt_table_wrap');
  const tHead = el('#kvt_table_head');
  const tBody = el('#kvt_table_body');

  const selClient  = el('#kvt_client');
  const selProcess = el('#kvt_process');
  const inpSearch  = el('#kvt_search');
  const btnRefresh = el('#kvt_refresh');
  const btnToggle  = el('#kvt_toggle_table');
  const btnCSV     = el('#kvt_export_csv');
  const btnXLS     = el('#kvt_export_xls');
  const btnAdd     = el('#kvt_add_profile');

  // Modal refs
  const modal      = el('#kvt_modal');
  const modalClose = el('.kvt-modal-close', modal);
  const modalList  = el('#kvt_modal_list', modal);
  const modalCli   = el('#kvt_modal_client', modal);
  const modalProc  = el('#kvt_modal_process', modal);
  const modalPrev  = el('#kvt_modal_prev', modal);
  const modalNext  = el('#kvt_modal_next', modal);
  const modalPage  = el('#kvt_modal_pageinfo', modal);
  const modalCreate= el('#kvt_modal_create_empty', modal);
  const modalSearch= el('#kvt_modal_search', modal);

  let currentPage = 1;

  function openModal(){
    modal.style.display = 'flex';
    // Pre-fill modal selects with current filters
    if (selClient && selClient.value) modalCli.value = selClient.value;
    filterModalProcessOptions();
    if (selProcess && selProcess.value) modalProc.value = selProcess.value;
    modalSearch.value = '';
    listProfiles(1);
  }
  function closeModal(){ modal.style.display = 'none'; }
  modalClose && modalClose.addEventListener('click', closeModal);
  modal && modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

  function filterProcessOptions(){
    const clientId = parseInt(selClient.value || '0', 10);
    const current = selProcess.value;
    selProcess.innerHTML = '<option value="">— Todos —</option>';
    (window.KVT_PROCESS_MAP||[]).forEach(p=>{
      if (!clientId || p.client_id === clientId) {
        const opt = document.createElement('option');
        opt.value = String(p.id);
        opt.textContent = p.name;
        selProcess.appendChild(opt);
      }
    });
    if (current && Array.from(selProcess.options).some(o=>o.value===current)) selProcess.value = current;
  }

  function filterModalProcessOptions(){
    const clientId = parseInt(modalCli.value || '0', 10);
    const current = modalProc.value;
    modalProc.innerHTML = '<option value="">— Ninguno —</option>';
    (window.KVT_PROCESS_MAP||[]).forEach(p=>{
      if (!clientId || p.client_id === clientId) {
        const opt = document.createElement('option');
        opt.value = String(p.id);
        opt.textContent = p.name;
        modalProc.appendChild(opt);
      }
    });
    if (current && Array.from(modalProc.options).some(o=>o.value===current)) modalProc.value = current;
  }
  modalCli && modalCli.addEventListener('change', filterModalProcessOptions);

  function renderBoardSkeleton(){
    board.innerHTML = '';
    KVT_STATUSES.forEach(st=>{
      const col = document.createElement('div');
      col.className = 'kvt-col'; col.dataset.status = st;
      const h = document.createElement('h3'); h.textContent = st;
      const zone = document.createElement('div'); zone.className = 'kvt-dropzone'; zone.dataset.status = st;
      col.appendChild(h); col.appendChild(zone);
      board.appendChild(col);
    });
  }

  function ajaxForm(params){
    const body = new URLSearchParams(params);
    return fetch(KVT_AJAX, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:body.toString() }).then(r=>r.json());
  }

  function cardTemplate(c){
    const card = document.createElement('div');
    card.className = 'kvt-card'; card.setAttribute('draggable','true'); card.dataset.id = c.id;

    const title = document.createElement('p'); title.className = 'kvt-title';
    title.textContent = (c.meta.first_name||'') + ' ' + (c.meta.last_name||'');
    if (title.textContent.trim()==='') title.textContent = c.title;

    const sub = document.createElement('p'); sub.className = 'kvt-sub';
    sub.textContent = c.meta.email || '';

    const meta = document.createElement('div'); meta.className = 'kvt-meta';
    const city = (c.meta.city? c.meta.city : '');
    const country = (c.meta.country? c.meta.country : '');
    if (city || country) {
      const loc = document.createElement('span');
      loc.textContent = [city,country].filter(Boolean).join(', ');
      meta.appendChild(loc);
    }
    if (c.meta.cv_uploaded) {
      const when = document.createElement('span');
      when.textContent = 'Subido: ' + c.meta.cv_uploaded;
      meta.appendChild(when);
    }
    const badge = document.createElement('span');
    badge.className = 'kvt-badge';
    badge.textContent = 'Notas: ' + (parseInt(c.meta.notes_count||0,10)||0);
    meta.appendChild(badge);

    const expand = document.createElement('div'); expand.className='kvt-expand';
    const btn = document.createElement('button'); btn.type='button'; btn.textContent='Ver perfil';
    const btnDel = document.createElement('button'); btnDel.type='button'; btnDel.className='kvt-delete dashicons dashicons-trash'; btnDel.setAttribute('title','Eliminar candidato');
    expand.appendChild(btn); expand.appendChild(btnDel);

    const panel = document.createElement('div'); panel.className='kvt-panel';
    panel.innerHTML = buildProfileHTML(c);

    btn.addEventListener('click', ()=>{
      const visible = panel.style.display === 'block';
      panel.style.display = visible ? 'none' : 'block';
      btn.textContent = visible ? 'Ver perfil' : 'Ocultar perfil';
    });

    // Drag
    card.addEventListener('dragstart', e=>{
      card.classList.add('dragging'); e.dataTransfer.setData('text/plain', String(c.id));
    });
    card.addEventListener('dragend', ()=> card.classList.remove('dragging'));

    // Delete
    btnDel.addEventListener('click', ()=>{
      if (!confirm('¿Mover a la papelera este candidato?')) return;
      ajaxForm({action:'kvt_delete_candidate', _ajax_nonce:KVT_NONCE, id:String(c.id)})
        .then(j=>{
          if (!j.success) return alert(j.data && j.data.msg ? j.data.msg : 'No se pudo eliminar.');
          card.remove();
        });
    });

    // Enable notes + profile edit
    enableNotesHandlers(card, String(c.id));
    enableProfileEditHandlers(card, String(c.id));

    card.appendChild(title); card.appendChild(sub); card.appendChild(meta);
    card.appendChild(expand); card.appendChild(panel);
    return card;
  }

  function buildProfileHTML(c){
    const m = c.meta||{};
    const input = (val,type='text',ph='')=>'<input class="kvt-input" type="'+type+'" value="'+esc(val||'')+'" placeholder="'+esc(ph||'')+'">';
    const kvInp = (label, html)=>'<dt>'+esc(label)+'</dt><dd>'+html+'</dd>';

    const dl =
      kvInp('Nombre',       input((m.first_name||''))) +
      kvInp('Apellidos',    input((m.last_name||''))) +
      kvInp('Email',        input((m.email||''), 'email')) +
      kvInp('Teléfono',     input((m.phone||''))) +
      kvInp('Ubicación (País)', input((m.country||''))) +
      kvInp('Ubicación (Ciudad)', input((m.city||''))) +
      kvInp('CV (URL)',     input((m.cv_url||''), 'url', 'https://...')) +
      kvInp('Fecha subida', input((m.cv_uploaded||''), 'text', 'YYYY-MM-DD HH:MM'));

    const notesVal = m.notes || '';
    const notes =
      '<div class="kvt-notes">'+
        '<label><strong>Notas</strong></label>'+
        '<textarea class="kvt-notes-text">'+esc(notesVal)+'</textarea>'+
        '<div class="row">'+
          '<button type="button" class="kvt-save-notes">Guardar notas</button>'+
          '<button type="button" class="kvt-delete-notes kvt-danger">Borrar notas</button>'+
          '<button type="button" class="kvt-save-profile">Guardar perfil</button>'+
        </div>'+
      '</div>';

    return '<dl>'+dl+'</dl>'+notes;
  }

  function enableNotesHandlers(card, id){
    const txt = card.querySelector('.kvt-notes-text');
    const btnSave = card.querySelector('.kvt-save-notes');
    const btnDel  = card.querySelector('.kvt-delete-notes');

    btnSave && btnSave.addEventListener('click', ()=>{
      const notes = txt ? txt.value : '';
      ajaxForm({action:'kvt_update_notes', _ajax_nonce:KVT_NONCE, id:id, notes:notes})
        .then(j=>{
          if (!j.success) return alert('No se pudo guardar.');
          const n = (notes.split(/\r?\n/).filter(l=>l.trim()!=='').length) || 0;
          const badge = card.querySelector('.kvt-badge'); if (badge) badge.textContent = 'Notas: '+n;
          alert('Notas guardadas.');
        });
    });
    btnDel && btnDel.addEventListener('click', ()=>{
      if (!confirm('¿Seguro que deseas borrar todas las notas?')) return;
      ajaxForm({action:'kvt_delete_notes', _ajax_nonce:KVT_NONCE, id:id})
        .then(j=>{
          if (!j.success) return alert('No se pudo borrar.');
          if (txt) txt.value = '';
          const badge = card.querySelector('.kvt-badge'); if (badge) badge.textContent = 'Notas: 0';
          alert('Notas borradas.');
        });
    });
  }

  function enableProfileEditHandlers(card, id){
    const inputs = card.querySelectorAll('dl .kvt-input');
    const btnSaveProfile = card.querySelector('.kvt-save-profile');
    if (!btnSaveProfile) return;

    btnSaveProfile.addEventListener('click', ()=>{
      const vals = Array.from(inputs).map(i=>i.value || '');
      const payload = {
        first_name: vals[0] || '',
        last_name:  vals[1] || '',
        email:      vals[2] || '',
        phone:      vals[3] || '',
        country:    vals[4] || '',
        city:       vals[5] || '',
        cv_url:     vals[6] || '',
        cv_uploaded:vals[7] || '',
      };
      const p = {
        action:'kvt_update_profile',
        _ajax_nonce: KVT_NONCE,
        id: id,
        ...payload
      };
      ajaxForm(p).then(j=>{
        if(!j.success) return alert(j.data && j.data.msg ? j.data.msg : 'No se pudo guardar el perfil.');
        // Update top text
        const title = card.querySelector('.kvt-title');
        const sub   = card.querySelector('.kvt-sub');
        if (title) title.textContent = (payload.first_name+' '+payload.last_name).trim() || title.textContent;
        if (sub)   sub.textContent   = payload.email || '';
        alert('Perfil guardado.');
      });
    });
  }

  function enableDnD(){
    els('.kvt-dropzone').forEach(zone=>{
      zone.addEventListener('dragover', e=>{ e.preventDefault(); });
      zone.addEventListener('drop', e=>{
        e.preventDefault();
        const id = e.dataTransfer.getData('text/plain');
        const newStatus = zone.dataset.status;
        const card = el('.kvt-card[data-id="'+id+'"]');
        if (card) zone.appendChild(card);
        ajaxForm({action:'kvt_update_status', _ajax_nonce:KVT_NONCE, id:id, status:newStatus});
      });
    });
  }

  function fetchCandidates(){
    const params = new URLSearchParams();
    params.set('action','kvt_get_candidates');
    params.set('_ajax_nonce', KVT_NONCE);
    params.set('client', selClient.value);
    params.set('process', selProcess.value);
    params.set('search', inpSearch.value);
    return fetch(KVT_AJAX, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:params.toString() }).then(r=>r.json());
  }

  function renderData(data){
    board.innerHTML = '';
    KVT_STATUSES.forEach(st=>{
      const col = document.createElement('div');
      col.className = 'kvt-col'; col.dataset.status = st;
      const h = document.createElement('h3'); h.textContent = st;
      const zone = document.createElement('div'); zone.className = 'kvt-dropzone'; zone.dataset.status = st;
      col.appendChild(h); col.appendChild(zone); board.appendChild(col);
    });

    data.forEach(c=>{
      const zone = el('.kvt-dropzone[data-status="'+(c.status||'')+'"]') || el('.kvt-dropzone');
      if (zone) {
        const card = cardTemplate(c);
        zone.appendChild(card);
      }
    });

    enableDnD();

    // Table (no selection column)
    tHead.innerHTML = KVT_COLUMNS.map(c=>'<th>'+esc(c.label)+'</th>').join('');
    tBody.innerHTML = data.map(row=>{
      const tds = KVT_COLUMNS.map(col=>{
        const val = row.meta[col.key] || '';
        if (col.key==='cv_url') {
          return '<td>'+(val ? '<a href="'+escAttr(val)+'" target="_blank" rel="noopener">Abrir</a>' : '')+'</td>';
        }
        return '<td>'+esc(val)+'</td>';
      }).join('');
      return '<tr>'+tds+'</tr>';
    }).join('');
  }

  function syncExportHidden(){
    el('#kvt_export_client').value  = selClient.value;
    el('#kvt_export_process').value = selProcess.value;
    el('#kvt_export_search').value  = inpSearch.value;
  }

  // Export buttons
  const exportForm = el('#kvt_export_form');
  btnCSV && btnCSV.addEventListener('click', ()=>{ el('#kvt_export_format').value='csv'; syncExportHidden(); exportForm.submit(); });
  btnXLS && btnXLS.addEventListener('click', ()=>{ el('#kvt_export_format').value='xls'; syncExportHidden(); exportForm.submit(); });

  // Toggle table
  btnToggle && btnToggle.addEventListener('click', ()=>{
    tableWrap.style.display = (tableWrap.style.display==='none' || !tableWrap.style.display) ? 'block' : 'none';
  });

  function refresh(){
    const hasFilter = (selClient && selClient.value) || (selProcess && selProcess.value);
    if (!hasFilter) {
      board.innerHTML = '<div class="kvt-empty">Selecciona un <strong>Cliente</strong> o un <strong>Proceso</strong> para ver candidatos.</div>';
      tHead.innerHTML = ''; tBody.innerHTML = '';
      return;
    }
    fetchCandidates().then(j=>{
      if(j.success){ renderData(j.data); } else { alert('Error cargando candidatos'); }
    });
  }
  btnRefresh && btnRefresh.addEventListener('click', refresh);
  selClient && selClient.addEventListener('change', ()=>{ filterProcessOptions(); refresh(); });
  selProcess && selProcess.addEventListener('change', refresh);
  let to=null; inpSearch && inpSearch.addEventListener('input', ()=>{ clearTimeout(to); to=setTimeout(refresh,300); });

  // ===== Modal: search + list & clone or create empty with Client/Process =====
  function listProfiles(page){
    currentPage = page || 1;
    const params = new URLSearchParams();
    params.set('action','kvt_list_profiles');
    params.set('_ajax_nonce', KVT_NONCE);
    params.set('page', currentPage);
    params.set('q', modalSearch.value || '');
    fetch(KVT_AJAX,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:params.toString()})
      .then(r=>r.json())
      .then(j=>{
        if(!j.success) return alert('No se pudo cargar la lista.');
        const {items,total,pages} = j.data;
        modalList.innerHTML = items.map(it=>{
          const m = it.meta||{};
          return '<div class="kvt-card-mini">'+
            '<h4>'+esc((m.first_name||'')+' '+(m.last_name||''))+'</h4>'+
            '<p style="margin:.2em 0;color:#64748b">'+esc(m.email||'')+'</p>'+
            '<div class="kvt-mini-actions">'+
              '<button type="button" class="kvt-btn" data-id="'+it.id+'">Duplicar</button>'+
            '</div>'+
          '</div>';
        }).join('');
        modalPage.textContent = 'Página '+currentPage+' de '+(pages||1);

        // Attach duplicate handlers
        els('.kvt-mini-actions .kvt-btn', modalList).forEach(b=>{
          b.addEventListener('click', ()=>{
            const id = b.getAttribute('data-id');
            const proc = modalProc.value; // may be empty
            const cli  = modalCli.value;  // may be empty
            const p = new URLSearchParams();
            p.set('action','kvt_clone_profile');
            p.set('_ajax_nonce', KVT_NONCE);
            p.set('source_id', id);
            p.set('process_id', proc);
            p.set('client_id', cli);
            fetch(KVT_AJAX,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:p.toString()})
              .then(r=>r.json()).then(j=>{
                if(!j.success) return alert(j.data && j.data.msg ? j.data.msg : 'No se pudo crear.');
                alert('Perfil creado (#'+j.data.id+').');
                closeModal();
                refresh();
              });
          });
        });
      });
  }
  modalPrev && modalPrev.addEventListener('click', ()=>{ if(currentPage>1) listProfiles(currentPage-1); });
  modalNext && modalNext.addEventListener('click', ()=>{ listProfiles(currentPage+1); });
  modalCreate && modalCreate.addEventListener('click', ()=>{
    const p = new URLSearchParams();
    p.set('action','kvt_clone_profile');
    p.set('_ajax_nonce', KVT_NONCE);
    p.set('source_id','0'); // create empty
    p.set('process_id', modalProc.value||'');
    p.set('client_id',  modalCli.value||'');
    fetch(KVT_AJAX,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:p.toString()})
      .then(r=>r.json()).then(j=>{
        if(!j.success) return alert(j.data && j.data.msg ? j.data.msg : 'No se pudo crear.');
        alert('Perfil vacío creado (#'+j.data.id+').');
        closeModal(); refresh();
      });
  });
  let mto=null;
  modalSearch && modalSearch.addEventListener('input', ()=>{ clearTimeout(mto); mto=setTimeout(()=>listProfiles(1), 300); });

  btnAdd && btnAdd.addEventListener('click', openModal);

  // Init
  filterProcessOptions();
  renderBoardSkeleton();
  refresh();
})();
JS;
            wp_add_inline_script('wp-util', $js);
        }
    }

    /* =========================
     * Data API
     * ========================= */
    public function ajax_get_candidates() {
        check_ajax_referer('kvt_nonce');
        if (!current_user_can('edit_posts')) wp_send_json_error(['msg'=>'Unauthorized'], 403);

        $client_id  = isset($_POST['client'])  ? intval($_POST['client'])  : 0;
        $process_id = isset($_POST['process']) ? intval($_POST['process']) : 0;
        $search     = isset($_POST['search'])  ? sanitize_text_field($_POST['search']) : '';

        // Only show when at least one filter is selected
        if ($client_id === 0 && $process_id === 0) {
            wp_send_json_success([]);
        }

        $tax_query = [];
        if ($process_id) {
            $tax_query[] = ['taxonomy'=>self::TAX_PROCESS,'field'=>'term_id','terms'=>[$process_id]];
            if ($client_id) $tax_query[] = ['taxonomy'=>self::TAX_CLIENT,'field'=>'term_id','terms'=>[$client_id]];
        } else {
            if ($client_id) {
                $proc_terms = get_terms(['taxonomy'=>self::TAX_PROCESS,'hide_empty'=>false]);
                $proc_ids = [];
                foreach ($proc_terms as $t) {
                    $cid = (int) get_term_meta($t->term_id, 'kvt_process_client', true);
                    if ($cid === $client_id) $proc_ids[] = $t->term_id;
                }
                if (!empty($proc_ids)) {
                    $tax_query = [
                        'relation' => 'OR',
                        ['taxonomy'=>self::TAX_CLIENT, 'field'=>'term_id','terms'=>[$client_id]],
                        ['taxonomy'=>self::TAX_PROCESS,'field'=>'term_id','terms'=>$proc_ids],
                    ];
                } else {
                    $tax_query[] = ['taxonomy'=>self::TAX_CLIENT,'field'=>'term_id','terms'=>[$client_id]];
                }
            }
        }

        $args = [
            'post_type'      => self::CPT,
            'post_status'    => 'any',
            'posts_per_page' => 500,
            's'              => $search,
        ];
        if (!empty($tax_query)) $args['tax_query'] = $tax_query;

        $q = new WP_Query($args);

        $data = [];
        foreach ($q->posts as $p) {
            $notes_raw = get_post_meta($p->ID,'kvt_notes',true);
            if ($notes_raw === '') $notes_raw = get_post_meta($p->ID,'notes',true); // legacy
            $meta = [
                'first_name'  => $this->meta_get_compat($p->ID,'kvt_first_name',['first_name']),
                'last_name'   => $this->meta_get_compat($p->ID,'kvt_last_name',['last_name']),
                'email'       => $this->meta_get_compat($p->ID,'kvt_email',['email']),
                'phone'       => $this->meta_get_compat($p->ID,'kvt_phone',['phone']),
                'country'     => $this->meta_get_compat($p->ID,'kvt_country',['country']),
                'city'        => $this->meta_get_compat($p->ID,'kvt_city',['city']),
                'cv_url'      => $this->meta_get_compat($p->ID,'kvt_cv_url',['cv_url']),
                'cv_uploaded' => $this->meta_get_compat($p->ID,'kvt_cv_uploaded',['cv_uploaded']),
                'notes'       => $notes_raw,
                'notes_count' => $this->count_notes($notes_raw),
            ];
            $data[] = [
                'id'     => $p->ID,
                'title'  => get_the_title($p),
                'status' => get_post_meta($p->ID,'kvt_status',true),
                'meta'   => $meta,
            ];
        }
        wp_send_json_success($data);
    }

    public function ajax_update_status() {
        check_ajax_referer('kvt_nonce');
        if (!current_user_can('edit_posts')) wp_send_json_error(['msg'=>'Unauthorized'],403);

        $id = isset($_POST['id']) ? intval($_POST['id']) : 0;
        $st = isset($_POST['status']) ? sanitize_text_field($_POST['status']) : '';

        $statuses = $this->get_statuses();
        if (!$id || !in_array($st, $statuses, true)) {
            wp_send_json_error(['msg'=>'Invalid'], 400);
        }
        update_post_meta($id, 'kvt_status', $st);
        wp_send_json_success(['ok'=>true]);
    }

    public function ajax_update_notes() {
        check_ajax_referer('kvt_nonce');
        if (!current_user_can('edit_posts')) wp_send_json_error(['msg'=>'Unauthorized'],403);
        $id = isset($_POST['id']) ? intval($_POST['id']) : 0;
        $notes = isset($_POST['notes']) ? wp_kses_post($_POST['notes']) : '';
        if (!$id) wp_send_json_error(['msg'=>'Invalid'], 400);
        update_post_meta($id, 'kvt_notes', $notes);
        update_post_meta($id, 'notes', $notes); // legacy mirror
        wp_send_json_success(['ok'=>true]);
    }

    public function ajax_delete_notes() {
        check_ajax_referer('kvt_nonce');
        if (!current_user_can('edit_posts')) wp_send_json_error(['msg'=>'Unauthorized'],403);
        $id = isset($_POST['id']) ? intval($_POST['id']) : 0;
        if (!$id) wp_send_json_error(['msg'=>'Invalid'], 400);
        delete_post_meta($id, 'kvt_notes');
        delete_post_meta($id, 'notes'); // legacy mirror
        wp_send_json_success(['ok'=>true]);
    }

    public function ajax_delete_candidate() {
        check_ajax_referer('kvt_nonce');
        if (!current_user_can('delete_posts')) wp_send_json_error(['msg'=>'Unauthorized'],403);
        $id = isset($_POST['id']) ? intval($_POST['id']) : 0;
        if (!$id) wp_send_json_error(['msg'=>'Invalid'], 400);
        $res = wp_trash_post($id);
        if (!$res) wp_send_json_error(['msg'=>'No se pudo mover a la papelera.']);
        wp_send_json_success(['ok'=>true]);
    }

    // ===== Edit profile from UI =====
    public function ajax_update_profile() {
        check_ajax_referer('kvt_nonce');
        if (!current_user_can('edit_posts')) wp_send_json_error(['msg'=>'Unauthorized'],403);

        $id = isset($_POST['id']) ? intval($_POST['id']) : 0;
        if (!$id || get_post_type($id)!==self::CPT) wp_send_json_error(['msg'=>'Invalid'],400);

        $fields = [
            'kvt_first_name' => isset($_POST['first_name']) ? sanitize_text_field($_POST['first_name']) : '',
            'kvt_last_name'  => isset($_POST['last_name'])  ? sanitize_text_field($_POST['last_name'])  : '',
            'kvt_email'      => isset($_POST['email'])      ? sanitize_email($_POST['email'])           : '',
            'kvt_phone'      => isset($_POST['phone'])      ? sanitize_text_field($_POST['phone'])      : '',
            'kvt_country'    => isset($_POST['country'])    ? sanitize_text_field($_POST['country'])    : '',
            'kvt_city'       => isset($_POST['city'])       ? sanitize_text_field($_POST['city'])       : '',
            'kvt_cv_url'     => isset($_POST['cv_url'])     ? esc_url_raw($_POST['cv_url'])             : '',
            'kvt_cv_uploaded'=> isset($_POST['cv_uploaded'])? sanitize_text_field($_POST['cv_uploaded']): '',
        ];
        foreach ($fields as $k=>$v) {
            update_post_meta($id, $k, $v);
            // legacy mirrors
            $legacy = str_replace('kvt_', '', $k);
            update_post_meta($id, $legacy, $v);
        }

        // Update title if needed
        $title = get_the_title($id);
        if (!$title) {
            $fn = $fields['kvt_first_name']; $ln = $fields['kvt_last_name'];
            $new = trim($fn.' '.$ln);
            if ($new) wp_update_post(['ID'=>$id,'post_title'=>$new]);
        }

        wp_send_json_success(['ok'=>true]);
    }

    // ===== List & Clone Profiles (20 per page) with search, create empty, and assign Client/Process =====
    public function ajax_list_profiles() {
        check_ajax_referer('kvt_nonce');
        if (!current_user_can('edit_posts')) wp_send_json_error(['msg'=>'Unauthorized'],403);
        $page = max(1, intval($_POST['page'] ?? 1));
        $pp   = 20;
        $qstr = sanitize_text_field($_POST['q'] ?? '');

        $meta_query = [];
        if ($qstr !== '') {
            $meta_query = [
                'relation' => 'OR',
                ['key'=>'kvt_first_name','value'=>$qstr,'compare'=>'LIKE'],
                ['key'=>'kvt_last_name', 'value'=>$qstr,'compare'=>'LIKE'],
                ['key'=>'kvt_email',     'value'=>$qstr,'compare'=>'LIKE'],
                ['key'=>'first_name',    'value'=>$qstr,'compare'=>'LIKE'], // legacy
                ['key'=>'last_name',     'value'=>$qstr,'compare'=>'LIKE'],
                ['key'=>'email',         'value'=>$qstr,'compare'=>'LIKE'],
            ];
        }

        $q = new WP_Query([
            'post_type' => self::CPT,
            'post_status' => 'any',
            'posts_per_page' => $pp,
            'paged' => $page,
            'orderby' => 'date',
            'order'   => 'DESC',
            's'       => $qstr,
            'meta_query' => $meta_query,
        ]);

        $items = [];
        foreach ($q->posts as $p) {
            $items[] = [
                'id' => $p->ID,
                'title' => get_the_title($p),
                'meta' => [
                    'first_name' => $this->meta_get_compat($p->ID,'kvt_first_name',['first_name']),
                    'last_name'  => $this->meta_get_compat($p->ID,'kvt_last_name',['last_name']),
                    'email'      => $this->meta_get_compat($p->ID,'kvt_email',['email']),
                ],
            ];
        }
        wp_send_json_success([
            'items' => $items,
            'total' => (int)$q->found_posts,
            'pages' => (int)$q->max_num_pages,
        ]);
    }

    public function ajax_clone_profile() {
        check_ajax_referer('kvt_nonce');
        if (!current_user_can('edit_posts')) wp_send_json_error(['msg'=>'Unauthorized'],403);

        $source_id  = intval($_POST['source_id'] ?? 0);
        $process_id = intval($_POST['process_id'] ?? 0);
        $client_id  = intval($_POST['client_id']  ?? 0);

        if ($source_id > 0 && get_post_type($source_id) !== self::CPT) {
            wp_send_json_error(['msg'=>'Origen inválido'],400);
        }

        // Create new post
        $new_id = wp_insert_post([
            'post_type' => self::CPT,
            'post_status' => 'publish',
            'post_title' => ($source_id ? (get_the_title($source_id).' (copia)') : 'Nuevo candidato'),
        ], true);
        if (is_wp_error($new_id)) wp_send_json_error(['msg'=>$new_id->get_error_message()],500);

        // Copy meta if cloning from source (with legacy compatibility)
        if ($source_id > 0) {
            $keys = [
                'kvt_first_name','first_name',
                'kvt_last_name','last_name',
                'kvt_email','email',
                'kvt_phone','phone',
                'kvt_country','country',
                'kvt_city','city',
                'kvt_cv_url','cv_url',
                'kvt_cv_uploaded','cv_uploaded',
                'kvt_status',
                'kvt_notes','notes'
            ];
            $seen = [];
            foreach ($keys as $k) {
                if (isset($seen[$k])) continue; $seen[$k]=1;
                $val = get_post_meta($source_id, $k, true);
                if ($val !== '') update_post_meta($new_id, $k, $val);
            }
        } else {
            // Empty defaults
            update_post_meta($new_id, 'kvt_status', 'Identified');
        }
                // Assign process/client on creation
        if ($process_id > 0) {
            wp_set_object_terms($new_id, [$process_id], self::TAX_PROCESS, false);
            $linked = (int) get_term_meta($process_id, 'kvt_process_client', true);
            if ($linked > 0) {
                wp_set_object_terms($new_id, [$linked], self::TAX_CLIENT, false);
            } elseif ($client_id > 0) {
                wp_set_object_terms($new_id, [$client_id], self::TAX_CLIENT, false);
            }
        } elseif ($client_id > 0) {
            wp_set_object_terms($new_id, [$client_id], self::TAX_CLIENT, false);
        }

        wp_send_json_success(['id'=>$new_id]);
    }

    /* =========================
     * Export
     * ========================= */
    public function handle_export() {
        if (!is_user_logged_in() || !current_user_can('edit_posts')) wp_die('Unauthorized');
        check_admin_referer('kvt_export','kvt_export_nonce');

        $format     = isset($_POST['format']) ? sanitize_text_field($_POST['format']) : 'csv';
        $client_id  = isset($_POST['filter_client'])  ? intval($_POST['filter_client'])  : 0;
        $process_id = isset($_POST['filter_process']) ? intval($_POST['filter_process']) : 0;
        $search     = isset($_POST['filter_search'])  ? sanitize_text_field($_POST['filter_search']) : '';

        $tax_query = [];
        if ($process_id) {
            $tax_query[] = ['taxonomy'=>self::TAX_PROCESS,'field'=>'term_id','terms'=>[$process_id]];
            if ($client_id) $tax_query[] = ['taxonomy'=>self::TAX_CLIENT,'field'=>'term_id','terms'=>[$client_id]];
        } else {
            if ($client_id) {
                $proc_terms = get_terms(['taxonomy'=>self::TAX_PROCESS,'hide_empty'=>false]);
                $proc_ids = [];
                foreach ($proc_terms as $t) {
                    $cid = (int) get_term_meta($t->term_id, 'kvt_process_client', true);
                    if ($cid === $client_id) $proc_ids[] = $t->term_id;
                }
                if (!empty($proc_ids)) {
                    $tax_query = [
                        'relation' => 'OR',
                        ['taxonomy'=>self::TAX_CLIENT, 'field'=>'term_id','terms'=>[$client_id]],
                        ['taxonomy'=>self::TAX_PROCESS,'field'=>'term_id','terms'=>$proc_ids],
                    ];
                } else {
                    $tax_query[] = ['taxonomy'=>self::TAX_CLIENT,'field'=>'term_id','terms'=>[$client_id]];
                }
            }
        }

        $args = [
            'post_type'      => self::CPT,
            'post_status'    => 'any',
            'posts_per_page' => -1,
            's'              => $search,
        ];
        if (!empty($tax_query)) $args['tax_query'] = $tax_query;

        $q = new WP_Query($args);

        $cols = $this->get_columns();
        $filename = 'pipeline_export_' . date('Ymd_His');

        if ($format === 'xls') {
            header('Content-Type: application/vnd.ms-excel; charset=UTF-8');
            header('Content-Disposition: attachment; filename="'.$filename.'.xls"');
        } else {
            header('Content-Type: text/csv; charset=UTF-8');
            header('Content-Disposition: attachment; filename="'.$filename.'.csv"');
        }
        header('Pragma: no-cache'); header('Expires: 0');

        $out = fopen('php://output', 'w');
        // UTF-8 BOM for Excel
        fwrite($out, "\xEF\xBB\xBF");

        // Header
        fputcsv($out, array_map(function($c){ return $c['label']; }, $cols));

        // Rows
        foreach ($q->posts as $p) {
            $row = [];
            foreach ($cols as $c) {
                // Export via legacy-compatible getter (tries kvt_* then legacy)
                $val = $this->meta_get_compat($p->ID, 'kvt_'.$c['key'], [$c['key']]);
                $row[] = is_array($val) ? json_encode($val) : $val;
            }
            fputcsv($out, $row);
        }

        fclose($out);
        exit;
    }
}

new Kovacic_Pipeline_Visualizer();
